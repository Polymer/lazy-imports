<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<script>
  (function() {
    'use strict';

    const __lazyImports = new Map();


    /**
     * Handles the actual import of each document and reporting the status
     *
     * @param {HTMLElement} link The link tag to import a document for
     * @param {HTMLElement} fromElement The element to search for lazy imports
     *                                  within.
     * @return {Promise}
     */
    function __requestImport(link, fromElement) {
      return link.promise = new Promise(function(resolve, reject) {
        const importHref = Polymer.importHref || fromElement.importHref;
        const resolvedUrl = fromElement.resolveUrl(link.getAttribute('href'));
        importHref(resolvedUrl, resolve, reject, true);
      });
    }

    /**
     * Calls `Polymer.Base.importHref` for each `<link rel="lazy-import"` in
     * the `dom-module` where the calling element is defined, where the
     * "group" attribute matches the provided "group". If no group is
     * provided, Lazy HTML Imports with no group will be imported.
     *
     * `importHref` is only called once per globally-unique URL.
     *
     * @param {HTMLElement} fromElement The element to search for lazy imports
     *                                  within.
     * @param {string=} group The group attribute to filter on.
     * @param {object=} options Accepts a retry flag which will force a
     *                          retry of a previously failed import.
     * @return {Promise}
     */
    Polymer.__importLazyGroup = function(fromElement, group, options) {
      const query =
        'link[rel=\'lazy-import\'][href]:not([href=\'\'])';

      if (!__lazyImports.get(fromElement)) {
        const links = Array.from(
          Polymer.DomModule.import(fromElement.localName)
          .querySelectorAll(query));

        __lazyImports.set(fromElement, links.reduce(function(obj, link) {
          const group = link.getAttribute('group');
          if (!obj[group]) {
            obj[group] = [];
          }
          obj[group].push(link);
          return obj;
        }, {}));
      }

      // Exit early if there is no associcated group
      const groupLinks = __lazyImports.get(fromElement)[group];
      if (!groupLinks) {
        return Promise.reject(
          new Error('No imports found in the specified group.'));
      }

      const importStatuses = {loaded: [], failed: []};
      const requestPromises = groupLinks.map(function(link) {
        let promise;

        // Use existing promise if available
        if (link.promise) {
          promise = link.promise;
          if (options && options.retry) {
            promise = promise.catch(function() {
              return __requestImport(link, fromElement);
            });
          }
        } else {
          promise = __requestImport(link, fromElement);
        }

        // Store request promise
        link.promise = promise;

        // Make all promises resolve for final output
        const href = link.getAttribute('href');
        return promise.then(
          function onLoad() {
            return importStatuses.loaded.push(href);
          },
          function onFail() {
            return importStatuses.failed.push(href);
          }
        );
      });
      return Promise.all(requestPromises).then(function() {
        if (importStatuses.failed.length > 0) {
          const error = new Error('One or more imports failed to load.');
          error.importStatuses = importStatuses;
          throw error;
        } else {
          return importStatuses;
        }
      });
    };
  })();
</script>
